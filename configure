#!/bin/sh
# Locates required system dependencies and generates a config file for later use.

set -e
cd "$(dirname "$0")"
source tools/utils.bash

function find-lua
{
    local manjor="$1"
    local minor="$2"
    for lua in "lua-$manjor.$minor" \
               "lua-$manjor$minor" \
               "lua$manjor.$minor" \
               "lua$manjor$minor" \
               "lua"; do
        if [ "$("$lua" -v || get-regex-group "Lua ([0-9.]{3})")" == "$manjor.$minor" ]; then
            echo "$lua"
            return 0
        fi
    done
    echoerr "Can't Lua $major.$minor."
    exit 1
}

function find-luarocks
{
    local major="$1"
    local minor="$1"
    for luarocks in "luarocks-$manjor.$minor" \
                    "luarocks-$manjor$minor" \
                    "luarocks$manjor.$minor" \
                    "luarocks$manjor$minor" \
                    "luarocks"; do
        if [ "$("$luarocks" config --lua-ver)" == "$major.$minor" ]; then
            echo "$luarocks"
            return 0
        fi
    done
    echoerr "Can't find LuaRocks for Lua $major.$minor."
    exit 1
}

function find-optional-program
{
    local name="$1"
    if has-program "$name"; then
        echo "$name"
    fi
}

# Lua:
lua="$(find-lua 5 2)"
lua_luarocks="$(find-luarocks 5 2)"
echo "Found $lua"
echo "Found $lua_luarocks"

# LuaJIT:
require-program 'luajit'
luajit='luajit'
luajit_luarocks="$(find-luarocks 5 1)"
echo "Found $luajit_luarocks"

# Argon2:
require-file /usr/include/argon2.h
require-file /usr/lib/libargon2.so

# FFmpeg:
require-program ffmpeg

# NodeJS:
require-program npm

# Optional dependencies:
luacheck="$(find-optional-program 'luacheck')"
busted="$(find-optional-program 'busted')"
ldoc="$(find-optional-program 'ldoc')"
apidoc="$(find-optional-program 'apidoc')"

# Lua package installation:
# Packages are either installed
# - global
# - local
# - bundled
# When installing them 'bundled' the packages are installed by running
# `luarocks --tree=... install --deps=mode=one`

cat >config.mk <<EOF
LUA="$lua"
LUA_LUAROCKS="$lua_luarocks"

LUAJIT="$luajit"
LUAJIT_LUAROCKS="$luajit_luarocks"

LUACHECK="$luacheck"
BUSTED="$busted"
LDOC="$ldoc"
APIDOC="$apidoc"
EOF
