#!/usr/bin/env luajit
local vips = require'vips'
local cjson = require'cjson'

local arg_string = assert(arg[1], 'Pass arguments as JSON.')
local args = assert(cjson.decode(arg_string))

local input_file  = assert(args.input_file)
local output_file = assert(args.output_file)
local target_size = assert(args.target_size)
local format_options = args.format_options or {}

local image = vips.Image.new_from_file(input_file)

io.stdout:write(cjson.encode{width  = image:width(),
                             height = image:height()}, '\n')

local scale = target_size / math.max(image:width(), image:height())
image = image:resize(scale)

image:write_to_file(output_file, format_options)
